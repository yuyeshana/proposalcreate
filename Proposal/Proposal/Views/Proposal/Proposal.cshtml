@model Proposal.Models.ProposalViewModel
@section Scripts {
    @* <script src="~/js/Proposal.js"></script> *@
    <script src="~/js/CascadingDropdown.js"></script>
    <script src="~/js/ProposalCreate.js"></script>
    <script src="~/js/FirstReview.js"></script>
    @await Html.PartialAsync("_ValidationScriptsPartial")
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="~/css/site.css" />
<link rel="stylesheet" href="~/css/Proposal.css" />
@{
    var showProposalContentFlag = (ViewBag.ShowProposalContent == true) ? "true" : "false";

    // 添加空值检查，防止 ViewDataDictionary 构造函数失败
    var basicInfo = Model?.BasicInfo ?? new Proposal.Models.ProposalModel();
    var proposalContent = Model?.ProposalContent ?? new Proposal.Models.ProposalContentModel();
    var firstReviewContent = Model?.FirstReviewContent ?? new Proposal.Models.FirstReviewContentModel();

    var basicInfoViewData = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary<Proposal.Models.ProposalModel>(ViewData, basicInfo);
    basicInfoViewData.TemplateInfo.HtmlFieldPrefix = "BasicInfo";
    var proposalContentViewData = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary<Proposal.Models.ProposalContentModel>(ViewData, proposalContent);
    proposalContentViewData.TemplateInfo.HtmlFieldPrefix = "ProposalContent";
    var firstReviewContentViewData = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary<Proposal.Models.FirstReviewContentModel>(ViewData, firstReviewContent);
    firstReviewContentViewData.TemplateInfo.HtmlFieldPrefix = "FirstReviewContent";
    var currentMode = Model?.Mode.ToString() ?? "create";
}
<div id="showProposalContentFlag" style="display:none">@showProposalContentFlag</div>
<div class="page-container">
    <div class="container">
        <h2 class="page-title"><i class="fas fa-file-alt me-3"></i>提案書作成</h2>
    </div>
    <div class="main-content" id="currentMode" data-current-mode="@currentMode">
        <div class="container">
            <form asp-action="Index" asp-controller="Proposal" id="proposalForm" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.BasicInfo.ProposalId)
                @Html.HiddenFor(m => m.BasicInfo.UserId)
                @Html.HiddenFor(m => m.Mode)
                @Html.HiddenFor(m => m.FirstReviewContent.ProposalId)
                <div class="navigation-card">
                    <div class="d-flex flex-column gap-3 w-100">
                        <div class="d-flex gap-2 justify-content-end w-100">
                            @switch (currentMode)
                            {
                                case "Create":
                                    <button type="button" class="btn btn-action btn-secondary" onclick="window.location.href='/proposalList'">
                                        <i class="fas fa-arrow-left me-2"></i>戻る
                                    </button>
                                    <button type="submit" name="action" value="CreateIchijihozon" class="btn btn-action btn-warning">
                                        <i class="fas fa-save me-2"></i>一時保存
                                    </button>
                                    <button type="submit" name="action" value="CreateDeryoku" class="btn btn-action btn-info">
                                        <i class="fas fa-download me-2"></i>出力
                                    </button>
                                    <button type="button" class="btn btn-action btn-outline-secondary" onclick="initializeForm()">
                                        <i class="fas fa-redo me-2"></i>初期化
                                    </button>
                                    <button type="submit" name="action" value="CreateSubmit" class="btn btn-action btn-success">
                                        <i class="fas fa-paper-plane me-2"></i>提出
                                    </button>
                                    break;

                                case "FirstReview":
                                    <button type="button" class="btn btn-action btn-secondary" onclick="window.location.href='/proposalList'">
                                        <i class="fas fa-arrow-left me-2"></i>戻る
                                    </button>
                                    <button type="submit" name="action" value="FirstReviewIchijihozon" class="btn btn-action btn-warning">
                                        <i class="fas fa-save me-2"></i>一時保存
                                    </button>
                                    <button type="submit" name="action" value="FirstReviewDeryoku" class="btn btn-action btn-info">
                                        <i class="fas fa-download me-2"></i>出力
                                    </button>
                                    <button type="submit" name="action" value="FirstReviewReturn" class="btn btn-action btn-outline-secondary">
                                        <i class="fas fa-redo me-2"></i>差戻し
                                    </button>
                                    <button type="submit" name="action" value="FirstReviewSubmit" class="btn btn-action btn-success">
                                        <i class="fas fa-paper-plane me-2"></i>提出
                                    </button>
                                    break;

                                default:
                                    break;
                            }
                        </div>
                        <div class="d-flex justify-content-start w-100">
                            <div class="nav-tabs-wrapper d-flex align-items-center">
                                <button type="button" id="btnBase" class="nav-tab active">
                                    <i class="fas fa-info-circle me-2"></i>基本情報
                                </button>
                                <button type="button" id="btnTeian" class="nav-tab">
                                    <i class="fas fa-lightbulb me-2"></i>提案内容
                                </button>
                                <button type="button" id="btnFirstReview" class="nav-tab @(currentMode == "FirstReview" ? "" : "d-none")">
                                    <i class="fas fa-lightbulb me-2"></i>第一次審査
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 基本情報フォーム -->
                @await Html.PartialAsync("~/Views/Proposal/_BasicInfo.cshtml", basicInfo, basicInfoViewData)
                <!-- 提案内容フォーム -->
                @await Html.PartialAsync("~/Views/Proposal/_ProposalContent.cshtml", proposalContent, proposalContentViewData)
                <!-- 一次審査フォーム -->
                @await Html.PartialAsync("~/Views/Proposal/_FirstReviewContent.cshtml", firstReviewContent, firstReviewContentViewData)
            </form>
        </div>
    </div>
</div>
